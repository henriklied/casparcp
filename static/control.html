<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Caspar control panel</title>
	<link rel="stylesheet" type="text/css" href="media/control.css">
	<script src="media/js/jquery.min.js"></script>
	<style type="text/css">
		#mapBox, #staticBox, #infoBox {
			display: none;
		}
	</style>
</head>
<body>

		<div id="superBox">
			<div class="super">
				<h2>Overordnet</h2>
				<p><input type="submit" class="out_btn all_out" value="ALT UT">
				<input type="submit" class="out_btn restart_casparcg" value="Restart uttegning"></p>
				<p><input type="submit" class="settings_btn start_timer" value="START TIMER!"></p>
				<p><input type="submit" class="out_btn send_rtx" value="Kjør rulletekst"></p>
				<p><input type="submit" class="settings_btn update_personsuper" value="Hent oppdaterte personsupre"></p>
			</div>
		</div>

<!-- 	<div id="config">
		<h2>Innstillinger</h2>
		<div class="container">
			<div class="super">
				<p><label>Sombi-URL <input type="text" value="" id="config_sombi_url"></label></p>

				<p><label>GPS-ID</label>
					<select id="config_gps_id">
						<option value="8">8</option>
						<option value="9">9</option>
						<option value="10">10</option>
						<option value="11">11</option>
						<option value="12">12</option>
					</select></p>

				<input type="submit" value="Lagre" id="config_save">
			</div>
		</div>
	</div> -->

	<div id="control">
		<div id="personSuper" class="container">
		</div>
		<div id="deadPresidents" class="container">
		</div>
		<div id="timerBox" class="container">
		</div>
		<div id="infoSuper" style="display: none;" class="container">
		</div>
		<div id="mapBox" class="container">
		</div>
		<div id="infoBox" class="container">
		</div>
		<div id="staticBox" class="container">
		</div>
		<div id="someBox" class="container">
		</div>
	</div>

<script src="/socket.io/socket.io.js"></script>
<script>
	var socket = io();
	var config;
	var presidentNum = 1;
String.prototype.replaceAll = function(search, replace) {
	//if replace is not sent, return original string otherwise it will
	//replace search string with 'undefined'.
	if (replace === undefined) {
		return this.toString();
	}

	return this.replace(new RegExp('[' + search + ']', 'g'), replace);
};

	var randomNum = function() { return Math.floor(Math.random()*1000)};

	$(document).ready(function() {

	function loadConfig() {
		$.get('config.json', function(data) {
			config = data;
			socket.emit('get_personsuper', config.personsuper_csv);
		});
	}

	loadConfig();

	function updatePersonsuper(data) {
		config.personsuper = data;
		socket.emit('list_shared', 1);
		$(".personsuper_csv").html('');
		$.each(data, function(k,v) {
			$('<option value="'+k+'">'+this.name+'</option>').appendTo('.personsuper_csv');
		});
	}


	$('#config input[type="submit"]').click(function(e) {
		socket.emit('config_save', {sombi_url: $("#config_sombi_url").val(), gps_id: $("#config_gps_id").val()})
		setTimeout(loadConfig, 1500);
	});

	function digas_status() {
		socket.emit("digasstatus", 1);
		setTimeout(digas_status, 5000);
	}
	digas_status();


	function generateMapSuper() {
		var html = '<div class="super">\
				<h2>Kartsuper</h2>\
				<input type="hidden" class="txt_personsuper_id" value="'+randomNum()+'">\
				<p><label>Zoomnivå\
					<select class="mapsuper_zoom">\
						<option value="10">Wide</option>\
						<option value="13">Nearer</option>\
						<option value="15">Nearest</option>\
					</select></label></p>\
				<p><label>Navn\
					<input type="text" class="txt_personsuper_name"></label></p>\
				<div class="submitters">\
					<input type="submit" class="map_in in_btn" value="INN">\
					<input type="submit" class="map_out out_btn" value="UT">\
				</div>\
			</div>';
		return html;		
	}
	function generatePresidentSuper() {
		var html = '<div class="super">\
				<h2>Presidentsuper</h2>\
				<input type="hidden" class="txt_personsuper_id" value="'+randomNum()+'">\
				<p><label>President nummer\
					<select class="president_number">\
						<option value="1">1</option>\
						<option value="2">2</option>\
						<option value="3">3</option>\
						<option value="4">4</option>\
						<option value="5">5</option>\
						<option value="6">6</option>\
						<option value="7">7</option>\
						<option value="8">8</option>\
						<option value="9">9</option>\
						<option value="10">10</option>\
						<option value="11">11</option>\
						<option value="12">12</option>\
						<option value="13">13</option>\
						<option value="14">14</option>\
						<option value="15">15</option>\
						<option value="16">16</option>\
						<option value="17">17</option>\
						<option value="18">18</option>\
						<option value="19">19</option>\
						<option value="20">20</option>\
						<option value="21">21</option>\
						<option value="22">22</option>\
						<option value="23">23</option>\
						<option value="24">24</option>\
						<option value="25">25</option>\
						<option value="26">26</option>\
						<option value="27">27</option>\
						<option value="28">28</option>\
						<option value="29">29</option>\
						<option value="30">30</option>\
						<option value="31">31</option>\
						<option value="32">32</option>\
						<option value="33">33</option>\
						<option value="34">34</option>\
						<option value="35">35</option>\
						<option value="36">36</option>\
						<option value="37">37</option>\
						<option value="38">38</option>\
						<option value="39">39</option>\
						<option value="40">40</option>\
						<option value="41">41</option>\
						<option value="42">42</option>\
						<option value="43">43</option>\
						<option value="44">44</option>\
					</select></label></p>\
				<div class="submitters">\
					<input type="submit" class="pres_in_current in_btn" value="INN valgt president">\
					<input type="submit" class="pres_in_next in_btn" value="NESTE president"><br><br>\
					<input type="submit" class="pres_in_prev in_btn" value="FORRIGE president">\
					<input type="submit" class="pres_out out_btn" value="UT president">\
				</div>\
			</div>';
		return html;		
	}
	function generateStaticBox() {
		var html = '<div class="super">\
						<input type="hidden" class="txt_infobox_id" value="staticbox">\
						<h2>Statiske bilder</h2>\
						<div class="chooser"><p><label class="staticchoice_label"> \
						<select class="staticchoice_data"></select></label><input type="submit" class="staticchoice_select" value="Velg"></p></div>\
						<p><label>Tittel</label><input type="text" class="staticchoice_title"></p>\
						<p><label>Fotocredits</label><input type="text" class="staticchoice_credits"></p>\
					<input type="submit" class="staticsubmit in_btn" value="Inn statisk bilde">\
					<input type="submit" class="staticsubmit out_btn" value="Ut statisk bilde">\
					</div>';
		$(html).appendTo("#staticBox");
	}
	generateStaticBox();


	socket.emit('list_shared', 1);
	socket.on('list_shared', function(e) {
		$('.staticchoice_data').html('');
		$.each(e, function(k, v) {
			if (this != '.gitignore') {
				$('<option value="'+this+'">'+this+'</option>').appendTo('.staticchoice_data');
			}
		});
	});

	$("#staticBox").on('click', 'input.staticchoice_select', function(e) {
		var fp = $(".staticchoice_data").val();
		var title = fp.replaceAll('_', ' ');
		title = title.split('.');
		var ext = title.pop();
		title = title.join('.');
		title = title.split(',');
		var credits = title[1];
		$(".staticchoice_title").val(title[0]);
		$(".staticchoice_credits").val(credits);
	});

	$("#staticBox").on('click', 'input.staticsubmit', function(e) {
		if ($(this).hasClass('in_btn')) {
			action = 'in';
		} else {
			action = 'out';
		}
		var container = $(this).parent();
		var data = {
			id: $(container).find('input[type="hidden"]').val(),
			src: $(container).find('.staticchoice_data').val(),
			title: $(container).find('.staticchoice_title').val(),
			credits: $(container).find('.staticchoice_credits').val(),
			action: action
		};
		console.log(data);
		socket.emit('static_image', data);
	});


	function generatePersonSuper(radio_name) {
		if (!radio_name) {
			radio_name = 'personsuper_position_1';
		} else {
			radio_name = 'personsuper_position_'+radio_name;
		}
		var html = '<div class="super">\
				<h2>Personsuper</h2>\
				<input type="hidden" class="txt_personsuper_id" value="'+randomNum()+'">\
				<p><label class="personsuper_csv_label">Personsupre\
					<select class="personsuper_csv"></select> <input type="submit" value="Sett inn"></label></p>\
				<p><label>Navn\
					<input type="text" class="txt_personsuper_name"></label></p>\
				<p><label>Tittel\
					<input type="text" class="txt_personsuper_title"></label></p>\
				<p><label>\
					<div class="cube">\
						<input type="radio" name="'+radio_name+'" value="topleft">&nbsp;&nbsp;&nbsp;\
						<input type="radio" name="'+radio_name+'" value="topright"><br>\
						<input type="radio" name="'+radio_name+'" value="bottomleft" checked="checked">&nbsp;&nbsp;&nbsp;\
						<input type="radio" name="'+radio_name+'" value="bottomright">\
					</div>\
				</label></p>\
				<div class="submitters">\
					<input type="submit" class="personsuper_inn in_btn" value="INN">\
				</div>\
			</div>';
		return html;
	}

	function generateInfoSuper(radio_name) {
		if (!radio_name) {
			radio_name = 'infosuper_position_1';
		} else {
			radio_name = 'infosuper_position_'+radio_name;
		}
		var html = '<div class="super">\
				<h2>Infosuper</h2>\
				<input type="hidden" class="txt_infosuper_id" value="'+randomNum()+'">\
				<p><label>Tekst\
					<input type="text" class="txt_infosuper"></label></p>\
				<p><label>\
					<div class="cube">\
						<input type="radio" name="'+radio_name+'" value="topleft">&nbsp;&nbsp;&nbsp;\
						<input type="radio" name="'+radio_name+'" value="topmiddle">&nbsp;&nbsp;&nbsp;\
						<input type="radio" name="'+radio_name+'" value="topright" checked="checked"><br>\
						<input type="radio" name="'+radio_name+'" value="bottomleft">&nbsp;&nbsp;&nbsp;\
						<input type="radio" name="'+radio_name+'" value="bottommiddle">&nbsp;&nbsp;&nbsp;\
						<input type="radio" name="'+radio_name+'" value="bottomright">\
					</div>\
				</label></p>\
				<div class="submitters">\
					<input type="submit" class="infosuper_inn in_btn" value="INN">\
					<input type="submit" class="infosuper_out out_btn" value="OUT">\
				</div>\
			</div>';
		return html;
	}

	function generateInfoBox(radio_name) {
		if (!radio_name) {
			radio_name = 'infobox_position_1';
		} else {
			radio_name = 'infobox_position_'+radio_name;
		}
		var html = '<div class="super">\
				<h2>Infoboks</h2>\
				<input type="hidden" class="txt_infobox_id" value="'+randomNum()+'">\
				<p><label>Tittel\
					<input type="text" class="txt_infobox_title"></label></p>\
				<p><label>Tekst\
					<textarea class="txt_infobox_text"></textarea></p>\
				<p><label> \
					<div class="cube">\
						<input type="radio" name="'+radio_name+'" value="topleft" checked="checked">&nbsp;&nbsp;&nbsp;\
						<input type="radio" name="'+radio_name+'" value="topright"><br>\
						<input type="radio" name="'+radio_name+'" value="bottomleft" disabled="disabled">&nbsp;&nbsp;&nbsp;\
						<input type="radio" name="'+radio_name+'" value="bottomright" disabled="disabled">\
					</div>\
				</label></p>\
				<div class="submitters">\
					<input type="submit" class="infobox_inn in_btn" value="INN">\
					<input type="submit" class="infobox_out out_btn" value="OUT">\
				</div>\
			</div>';
		return html;
	}


	function generateTimerBox() {
		var html = '<div class="super">\
				<h2>Nedtelling</h2>\
				<p><label>Manuell tid (minutter)\
					<input type="text" class="txt_manual_timestamp"></label></p>\
				<div class="submitters">\
					<input type="submit" class="timer_inn in_btn" value="Timer INN">\
					<input type="submit" class="timer_out out_btn" value="Timer UT">\
					<input type="submit" class="timer_newtime out_btn" value="Timer START MANUELL TID">\
				</div>\
			</div>';
		return html;
	}

	function generateSomeBox(radio_name) {
		if (!radio_name) {
			radio_name = 'somebox_position_1';
		} else {
			radio_name = 'somebox_position_'+radio_name;
		}
		var html = '<div class="super">\
				<h2>SoMe-boks</h2>\
				<input type="hidden" class="txt_somebox_id" value="'+randomNum()+'">\
				<p><label>URL\
					<input type="url" class="txt_somebox_url" style="display: inline;"> <input type="submit" class="load_someurl" value="Last inn"></label></p>\
				<p><label>Tittel\
					<input type="text" class="txt_somebox_title"></label></p>\
				<p><label>Tekst\
					<textarea class="txt_somebox_text"></textarea></p>\
				<p><label><input type="checkbox" class="source-facebook some-source" value="facebook"> Facebook</label><br><label><input type="checkbox" class="source-twitter some-source" value="twitter"> Twitter</label></p>\
				<p><label> \
					<div class="cube">\
						<input type="radio" name="'+radio_name+'" value="topleft" checked="checked">&nbsp;&nbsp;&nbsp;\
						<input type="radio" name="'+radio_name+'" value="topright"><br>\
						<input type="radio" name="'+radio_name+'" value="bottomleft" disabled="disabled">&nbsp;&nbsp;&nbsp;\
						<input type="radio" name="'+radio_name+'" value="bottomright" disabled="disabled">\
					</div>\
				</label></p>\
				<div class="submitters">\
					<input type="submit" class="somebox_inn in_btn" value="INN">\
					<input type="submit" class="somebox_out out_btn" value="OUT">\
				</div>\
			</div>';
		return html;
	}


	$(generatePersonSuper()).appendTo("#personSuper");
	$(generatePresidentSuper()).appendTo("#deadPresidents");
	$(generateInfoSuper()).appendTo("#infoSuper");
	$(generateInfoBox()).appendTo("#infoBox");
	$(generateSomeBox()).appendTo("#someBox");
	$(generateMapSuper()).appendTo("#mapBox");
	$(generateTimerBox()).appendTo("#timerBox");

	$("#superBox").on('click', 'input.all_out', function(e) {
		socket.emit('all_out', 1);
	});

	$("#personSuper h2:first").append(' <a href="#">+</a>').on('click', function(e) {
		$(generatePersonSuper(randomNum())).appendTo("#personSuper");
		updatePersonsuper(config.personsuper);
		$("#personSuper h2:last").append(' <a href="#">-</a>').on('click', function(e) {
			$(this).parent().remove();
		});
	});
	$("#infoSuper h2:first").append(' <a href="#">+</a>').on('click', function(e) {
		$(generateInfoSuper(randomNum())).appendTo("#infoSuper");
		$("#infoSuper h2:last").append(' <a href="#">-</a>').on('click', function(e) {
			$(this).parent().remove();
		});
	});
	$("#infoBox h2:first").append(' <a href="#">+</a>').on('click', function(e) {
		$(generateInfoBox(randomNum())).appendTo("#infoBox");
		$("#infoBox h2:last").append(' <a href="#">-</a>').on('click', function(e) {
			$(this).parent().remove();
		});
	});
	$("#someBox h2:first").append(' <a href="#">+</a>').on('click', function(e) {
		$(generateSomeBox(randomNum())).appendTo("#someBox");
		$("#someBox h2:last").append(' <a href="#">-</a>').on('click', function(e) {
			$(this).parent().remove();
		});
	});
	$("#mapBox h2:first").append(' <a href="#">+</a>').on('click', function(e) {
		$(generateMapSuper()).appendTo("#mapBox");
		$("#mapBox h2:last").append(' <a href="#">-</a>').on('click', function(e) {
			$(this).parent().remove();
		});
	});

	$("#infoBox").on('click', 'input[type="submit"]', function(e) {
		if ($(this).hasClass('infobox_inn')) {
			action = 'in';
		} else {
			action = 'out';
		}
		var container = $(this).parent().parent();
		var data = {
			id: $(container).find('input[type="hidden"]').val(),
			title: $(container).find('.txt_infobox_title').val(),
			text: $(container).find('.txt_infobox_text').val(),
			position: $(container).find('input[type="radio"]:checked').val(),
			action: action
		};
		socket.emit('infobox', data);
	});


	$("#infoSuper").on('click', 'input[type="submit"]', function(e) {
		if ($(this).hasClass('infosuper_inn')) {
			action = 'in';
		} else {
			action = 'out';
		}
		var container = $(this).parent().parent();
		var data = {
			id: $(container).find('input[type="hidden"]').val(),
			text: $(container).find('.txt_infosuper').val(),
			position: $(container).find('input[type="radio"]:checked').val(),
			action: action
		};
		socket.emit('infosuper', data);
	});
	$("#personSuper").on('click', '.personsuper_inn', function(e) {
		var container = $(this).parent().parent();
		var data = {
			id: $(container).find('input[type="hidden"]').val(),
			name: $(container).find('.txt_personsuper_name').val(),
			title: $(container).find('.txt_personsuper_title').val(),
			position: $(container).find('input[type="radio"]:checked').val(),
		};
		socket.emit('personsuper', data);
	});

	$("#personSuper").on('click', '.personsuper_csv_label input[type="submit"]', function(e) {
		var choice = $(this).parent().find('select').val();
		choice = config.personsuper[choice];
		$(this).parent().parent().parent().find('.txt_personsuper_name').val(choice.name);
		$(this).parent().parent().parent().find('.txt_personsuper_title').val(choice.title);
	});

	$("#timerBox").on('click', '.timer_inn', function(e) {
		socket.emit('in_timer', 1);
	});
	$("#timerBox").on('click', '.timer_out', function(e) {
		socket.emit('out_timer', 1);
	});
	$("#timerBox").on('click', '.timer_newtime', function(e) {
		socket.emit('set_timer', $(this).parent().parent().find('.txt_manual_timestamp').val());
	});
	$("#deadPresidents").on('click', 'input.pres_in_current', function(e) {
		socket.emit('in_president', parseInt($(".president_number").val()));
	});
	$("#deadPresidents").on('click', 'input.pres_in_next', function(e) {
		valu = parseInt($(".president_number").val())+1;
		socket.emit('in_president', valu);
		nextVisible = $(".president_number").val(valu);
	});
	$("#deadPresidents").on('click', 'input.pres_in_prev', function(e) {
		valu = parseInt($(".president_number").val())-1;
		socket.emit('in_president', valu);
		nextVisible = $(".president_number").val(valu);
	});
	$("#deadPresidents").on('click', 'input.pres_out', function(e) {
		socket.emit('out_president', 1);
	});
	
	$("#superBox").on('click', 'input.instagram_start', function(e) {
		socket.emit('instagram', 1);
	});
	$("#superBox").on('click', 'input.instagram_out', function(e) {
		socket.emit('instagram_out', 1);
	});
	$("#superBox").on('click', 'input.run_progsuper', function(e) {
		socket.emit('run_programsuper', 1);
	});
	$("#superBox").on('click', 'input.run_nrklogo', function(e) {
		socket.emit('run_nrklogo', 1);
	});
	$("#superBox").on('click', 'input.instagram_refresh', function(e) {
		socket.emit('instagram_refresh', config.sombi_url);
	});
	$("#superBox").on('click', 'input.send_rtx', function(e) {
		socket.emit('rtx', 1);
	});
	$("#superBox").on('click', 'input.start_timer', function(e) {
		socket.emit('start_timer', 1);
	});


	$("#superBox").on('change', 'input#activate_digas', function(e) {
		console.log(this.checked);
		socket.emit('activate_digas', this.checked);
	});

	$("#superBox").on('click', 'input.update_personsuper', function(e) {
		socket.emit('get_personsuper', config.personsuper_csv);
	});


	$("#someBox").on('click', 'input.somebox_inn, input.somebox_out', function(e) {
		if ($(this).hasClass('somebox_inn')) {
			action = 'in';
		} else {
			action = 'out';
		}
		var container = $(this).parent().parent();
		var data = {
			id: $(container).find('input[type="hidden"]').val(),
			title: $(container).find('.txt_somebox_title').val(),
			text: $(container).find('.txt_somebox_text').val(),
			position: $(container).find('input[type="radio"]:checked').val(),
			source: $(container).find('input.some-source:checked').val(),
			action: action
		};
		socket.emit('somesuper', data);
	});

	$(".restart_casparcg").click(function() {
		socket.emit('restart_casparcg', 1);
	});


	$("#someBox").on('click', 'input.load_someurl', function(e) {
		var container = $(this).parent().parent().parent();
		socket.emit('get_some', {url: $(container).find(".txt_somebox_url").val(), id: $(container).find('input[type="hidden"]').val()});
	});


	$("#mapBox").on('click', 'input[type="submit"]', function(e) {
		if ($(this).hasClass("map_in")) {
			var action = 'in';
		} else {
			var action = 'out';
		}
		var container = $(this).parent().parent();
		$.getJSON("https://nrk.cartodb.com/api/v2/sql?q=SELECT%20latitude,%20longitude,%20gps_id%20FROM%20nrk.saltstraumen_gps%20WHERE%20gps_id='NRKBeta08'%20ORDER%20BY%20dt%20ASC", function(json) {
			last = json.rows.pop();
			var data = {
				id: $(container).find('input[type="hidden"]').val(),
				zoom: $(container).find('.mapsuper_zoom').val(),
				latitude: parseFloat(last.latitude),
				longitude: parseFloat(last.longitude),
				action: action
			};
			socket.emit('map', data);
		});

	});
	//60.980676, 10.617256

	socket.on('get_some', function(data) {
		container = $('input[value="'+data.id+'"]').parent();
		$(container).find('.some-source').prop('checked', false);
		$(container).find(".txt_somebox_text").val(data.text);
		$(container).find(".txt_somebox_title").val(data.title);
		$(container).find(".source-"+data.source).prop('checked', true);
	});

	socket.on('instagram_refresh', function(msg) {
		console.log("Insta refresh", msg);
	});

	socket.on('get_personsuper', function(data) {
		updatePersonsuper(data);
	});


	socket.on('digas_super', function(cmd) {
		console.log(cmd);
		$("#digas").html(cmd.title);
	});


	});
</script>

</body>
</html>

