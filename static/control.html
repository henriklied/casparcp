<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Caspar control panel</title>
	<link rel="stylesheet" type="text/css" href="media/control.css">
	<script src="media/js/jquery.min.js"></script>
</head>
<body>

		<div id="superBox">
			<div class="super">
				<h2>Overordnet</h2>
				<p><input type="submit" class="out_btn all_out" value="ALT UT">
				<input type="submit" class="out_btn restart_casparcg" value="Restart uttegning"></p>
				<p><input type="submit" class="settings_btn update_personsuper" value="Hent oppdaterte personsupre"></p>
				<p><input type="text" class="instagram_refresh_county" value="01"> <input type="submit" class="settings_btn instagram_refresh" value="Oppdater Instagram-bilder"></p>
				<input type="submit" class="in_btn instagram_start" value="INN Instagram"></p>
				<input type="submit" class="out_btn instagram_out" value="UT Instagram"></p>
				<p><label>Aktiver DIGAS</label><input type="checkbox" id="activate_digas" checked></p>
			</div>
		</div>

<!-- 	<div id="config">
		<h2>Innstillinger</h2>
		<div class="container">
			<div class="super">
				<p><label>Sombi-URL <input type="text" value="" id="config_sombi_url"></label></p>

				<p><label>GPS-ID</label>
					<select id="config_gps_id">
					  <option value="8">8</option>
					  <option value="9">9</option>
					  <option value="10">10</option>
					  <option value="11">11</option>
					  <option value="12">12</option>
					</select></p>

				<input type="submit" value="Lagre" id="config_save">
			</div>
		</div>
	</div> -->

	<div id="control">
		<div id="personSuper" class="container">
		</div>
		<div id="playerBox" class="container">
		</div>
		<div id="infoBox" class="container">
		</div>
		<div id="someBox" class="container">
		</div>
		<div id="locationSuper" class="container">
		</div>
		<div id="infoSuper" class="container">
		</div>
		<div id="staticBox" class="container">
		</div>
	</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  var socket = io();
  var config;
  var tmp;
  var minecraftData;
	String.prototype.capitalize = function() {
		return this.charAt(0).toUpperCase() + this.slice(1);
	}
	String.prototype.replaceAll = function(search, replace)
	{
	    //if replace is not sent, return original string otherwise it will
	    //replace search string with 'undefined'.
	    if (replace === undefined) {
	        return this.toString();
	    }

	    return this.replace(new RegExp('[' + search + ']', 'g'), replace);
	};
	String.prototype.toProperCase = function () {
	    return this.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
	};

function convertToRange(value, srcRange, dstRange){
  // value is outside source range return
  if (value < srcRange[0] || value > srcRange[1]){
    return NaN; 
  }

  var srcMax = srcRange[1] - srcRange[0],
      dstMax = dstRange[1] - dstRange[0],
      adjValue = value - srcRange[0];

  return (adjValue * dstMax / srcMax) + dstRange[0];

}

  var randomNum = function() { return Math.floor(Math.random()*1000)};

  $(document).ready(function() {

  	function loadConfig() {
		$.get('config.json', function(data) {
			config = data;
			socket.emit('get_personsuper', config.personsuper_csv);
		});
  	}

  	loadConfig();

  	function updatePersonsuper(data) {
  		config.personsuper = data;
  		$(".personsuper_csv").html('');
  		$.each(data, function(k,v) {
  			$('<option value="'+k+'">'+this.name+'</option>').appendTo('.personsuper_csv');
  		});
  	}


  	$('#config input[type="submit"]').click(function(e) {
  		socket.emit('config_save', {sombi_url: $("#config_sombi_url").val(), gps_id: $("#config_gps_id").val()})
  		setTimeout(loadConfig, 1500);
  	});

	function digas_status() {
		socket.emit("digasstatus", 1);
		setTimeout(digas_status, 5000);
	}
	digas_status();

  	function generatePersonSuper(radio_name) {
		if (!radio_name) {
			radio_name = 'personsuper_position_1';
		} else {
			radio_name = 'personsuper_position_'+radio_name;
		}
  		var html = '<div class="super">\
				<h2>Personsuper</h2>\
				<input type="hidden" class="txt_personsuper_id" value="'+randomNum()+'">\
				<p><label class="personsuper_csv_label">Personsupre\
					<select class="personsuper_csv"></select> <input type="submit" value="Sett inn"></label></p>\
				<p><label>Navn\
					<input type="text" class="txt_personsuper_name"></label></p>\
				<p><label>Tittel\
					<input type="text" class="txt_personsuper_title"></label></p>\
				<p><label>\
					<div class="cube">\
					  <input type="radio" name="'+radio_name+'" value="topleft">&nbsp;&nbsp;&nbsp;\
					  <input type="radio" name="'+radio_name+'" value="topright"><br>\
					  <input type="radio" name="'+radio_name+'" value="bottomleft" checked="checked">&nbsp;&nbsp;&nbsp;\
					  <input type="radio" name="'+radio_name+'" value="bottomright">\
					</div>\
				</label></p>\
				<div class="submitters">\
					<input type="submit" class="personsuper_inn in_btn" value="INN">\
				</div>\
			</div>';
		return html;
  	}

  	function generateInfoSuper(radio_name) {
		if (!radio_name) {
			radio_name = 'infosuper_position_1';
		} else {
			radio_name = 'infosuper_position_'+radio_name;
		}
		var html = '<div class="super">\
				<h2>Infosuper</h2>\
				<input type="hidden" class="txt_infosuper_id" value="'+randomNum()+'">\
				<p><label>Tekst\
					<input type="text" class="txt_infosuper"></label></p>\
				<p><label>\
					<div class="cube">\
					  <input type="radio" name="'+radio_name+'" value="topleft">&nbsp;&nbsp;&nbsp;\
					  <input type="radio" name="'+radio_name+'" value="topmiddle">&nbsp;&nbsp;&nbsp;\
					  <input type="radio" name="'+radio_name+'" value="topright" checked="checked"><br>\
					  <input type="radio" name="'+radio_name+'" value="bottomleft">&nbsp;&nbsp;&nbsp;\
					  <input type="radio" name="'+radio_name+'" value="bottommiddle">&nbsp;&nbsp;&nbsp;\
					  <input type="radio" name="'+radio_name+'" value="bottomright">\
					</div>\
				</label></p>\
				<div class="submitters">\
					<input type="submit" class="infosuper_inn in_btn" value="INN">\
					<input type="submit" class="infosuper_out out_btn" value="OUT">\
				</div>\
			</div>';
		return html;
  	}

  	function generateInfoBox(radio_name) {
		if (!radio_name) {
			radio_name = 'infobox_position_1';
		} else {
			radio_name = 'infobox_position_'+radio_name;
		}
		var html = '<div class="super">\
				<h2>Infoboks</h2>\
				<input type="hidden" class="txt_infobox_id" value="'+randomNum()+'">\
				<p><label class="infosuper_label">Byggverk <select class="infosuper_data">';
		  		$.each(minecraftData, function(i, e) {
					html += '<option value="'+this.id+'">'+this.build+'</option>';
		  		});
			html += '</select></label></p><p><label>Tittel\
					<input type="text" class="txt_infobox_title"></label></p>\
				<p><label>Hvem\
					<input type="text" class="txt_infobox_who"></label></p>\
				<p><label>Tekst\
					<textarea class="txt_infobox_text"></textarea></p>\
				<p><label> \
					<div class="cube">\
					  <input type="radio" name="'+radio_name+'" value="topleft" checked="checked">&nbsp;&nbsp;&nbsp;\
					  <input type="radio" name="'+radio_name+'" value="topright"><br>\
					  <input type="radio" name="'+radio_name+'" value="bottomleft" disabled="disabled">&nbsp;&nbsp;&nbsp;\
					  <input type="radio" name="'+radio_name+'" value="bottomright" disabled="disabled">\
					</div>\
				</label></p>\
				<div class="submitters">\
					<input type="submit" class="infobox_inn in_btn" value="INN">\
					<input type="submit" class="infobox_out out_btn" value="OUT">\
				</div>\
			</div>';
		return html;
  	}

  	function generatePlayerSuper() {
		url = 'https://messenger.sosial.me/index.php?names';
		$.getJSON(url, function(data) {
			minecraftData = data;
		  	$(generateInfoBox()).appendTo("#infoBox");
	  		var html = '<div class="super">\
					<h2>Spillersuper</h2>\
					<input type="hidden" class="txt_playersuper_id" value="'+randomNum()+'">\
					<p><label class="playersuper_label">Personsupre <select class="playersuper_data">';
			$.each(data, function(i, e) {
				html += '<option value="'+this.id+'">'+this.username+'</option>';
			});
			html += '</select> <input type="submit" value="Sett inn"></label></p>\
					<div class="playerz"></div>\
					<p><label>Brukernavn\
						<input type="text" class="txt_playersuper_username"></label></p>\
					<p><label>Navn\
						<input type="text" class="txt_playersuper_name"></label></p>\
					<p><label>Sted\
						<input type="text" class="txt_playersuper_place"></label></p>\
					<p><label>Alder\
						<input type="text" class="txt_playersuper_age"></label></p>\
					<p><label>Om-tekst\
						<textarea class="txt_playersuper_about"></textarea></label></p>\
						<textarea class="txt_playersuper_about2"></textarea></label></p>\
					<div class="submitters">\
						<input type="submit" class="playersuper_inn in_btn" value="INN">\
						<input type="submit" class="playersuper_out out_btn" value="OUT">\
						<input type="submit" class="infotxts" value="0">\
						<input type="submit" class="infotxts" value="1">\
					</div>\
				</div>';
			$(html).appendTo("#playerBox");
		});		
  	}
  	generatePlayerSuper();


socket.emit('list_shared', 1);
socket.on('list_shared', function(e) {
	$.each(e, function(k, v) {
		if (this != '.gitignore') {
			$('<option value="'+this+'">'+this+'</option>').appendTo('.staticchoice_data');
		}
	});
});


  	function generateLocationBox() {
  		var html = '<div class="super">\
				<h2>Lokasjonssuper</h2>\
				<div class="submitters">\
					<input type="submit" class="placesuper_inn in_btn" value="Inn stedssuper">\
					<input type="submit" class="placesuper_out out_btn" value="Ut stedssuper">\
					<input type="submit" class="smallmap_inn in_btn" value="Inn lite kart">\
					<input type="submit" class="smallmap_out out_btn" value="Ut lite kart"><br>\
					<div class="bigmap"><label>Stort kart:\
					<input type="text" class="bigmap_url" value="http://139.162.190.146/mapcraft/latest/#world_topdown_day/0/2/187/-21/64"></label><br>\
					<input type="submit" class="largemap_inn in_btn" value="Inn STORT kart">\
					<input type="submit" class="largemap_out out_btn" value="Ut STORT kart"><br>\
				</div>\
				</div>\
			</div>';
		$(html).appendTo("#locationSuper");
  	}
  	generateLocationBox();


  	function generateStaticBox() {
  		var html = '<div class="super">\
						<input type="hidden" class="txt_infobox_id" value="staticbox">\
	  					<h2>Statiske bilder</h2>\
	  					<div class="chooser"><p><label class="staticchoice_label"> \
	  					<select class="staticchoice_data"></select></label><input type="submit" class="staticchoice_select" value="Velg"></p></div>\
	  					<p><label>Tittel</label><input type="text" class="staticchoice_title"></p>\
					<input type="submit" class="staticsubmit in_btn" value="Inn statisk bilde">\
					<input type="submit" class="staticsubmit out_btn" value="Ut statisk bilde">\
  					</div>';
  		$(html).appendTo("#staticBox");
  	}
  	generateStaticBox();

  	function generateSomeBox(radio_name) {
		if (!radio_name) {
			radio_name = 'somebox_position_1';
		} else {
			radio_name = 'somebox_position_'+radio_name;
		}
		var html = '<div class="super">\
				<h2>SoMe-boks</h2>\
				<input type="hidden" class="txt_somebox_id" value="'+randomNum()+'">\
				<p><label>URL\
					<input type="url" class="txt_somebox_url" style="display: inline;"> <input type="submit" class="load_someurl" value="Last inn"></label></p>\
				<p><label>Tittel\
					<input type="text" class="txt_somebox_title"></label></p>\
				<p><label>Brukernavn\
					<input type="text" class="txt_somebox_username"></label></p>\
				<p><label>Tekst\
					<textarea class="txt_somebox_text"></textarea></p>\
				<p><label><input type="checkbox" class="source-facebook some-source" value="facebook"> Facebook</label><br><label><input type="checkbox" class="source-twitter some-source" value="twitter"> Twitter</label></p>\
				<p><label> \
					<div class="cube">\
					  <input type="radio" name="'+radio_name+'" value="topleft" checked="checked">&nbsp;&nbsp;&nbsp;\
					  <input type="radio" name="'+radio_name+'" value="topright"><br>\
					  <input type="radio" name="'+radio_name+'" value="bottomleft" disabled="disabled">&nbsp;&nbsp;&nbsp;\
					  <input type="radio" name="'+radio_name+'" value="bottomright" disabled="disabled">\
					</div>\
				</label></p>\
				<div class="submitters">\
					<input type="submit" class="somebox_inn in_btn" value="INN">\
					<input type="submit" class="somebox_out out_btn" value="OUT">\
				</div>\
			</div>';
		return html;
  	}


  	$(generatePersonSuper()).appendTo("#personSuper");
  	$(generateInfoSuper()).appendTo("#infoSuper");
  	$(generateSomeBox()).appendTo("#someBox");


  	$("#superBox").on('click', 'input.all_out', function(e) {
  		socket.emit('all_out', 1);
  	});

  	$("#personSuper h2:first").append(' <a href="#">+</a>').on('click', function(e) {
	  	$(generatePersonSuper(randomNum())).appendTo("#personSuper");
	  	updatePersonsuper(config.personsuper);
	  	$("#personSuper h2:last").append(' <a href="#">-</a>').on('click', function(e) {
	  		$(this).parent().remove();
	  	});
  	});
  	$("#infoSuper h2:first").append(' <a href="#">+</a>').on('click', function(e) {
	  	$(generateInfoSuper(randomNum())).appendTo("#infoSuper");
	  	$("#infoSuper h2:last").append(' <a href="#">-</a>').on('click', function(e) {
	  		$(this).parent().remove();
	  	});
  	});
  	$("#infoBox h2:first").append(' <a href="#">+</a>').on('click', function(e) {
	  	$(generateInfoBox(randomNum())).appendTo("#infoBox");
	  	$("#infoBox h2:last").append(' <a href="#">-</a>').on('click', function(e) {
	  		$(this).parent().remove();
	  	});
  	});
  	$("#someBox h2:first").append(' <a href="#">+</a>').on('click', function(e) {
	  	$(generateSomeBox(randomNum())).appendTo("#someBox");
	  	$("#someBox h2:last").append(' <a href="#">-</a>').on('click', function(e) {
	  		$(this).parent().remove();
	  	});
  	});


  	$("#playerBox").on('click', '.playersuper_label input[type="submit"]', function(e) {
  		user_id = $(this).parent().find('select').val();
  		$.each(minecraftData, function(i, e) {
  			if (this.id == user_id) {
  				$(".txt_playersuper_username").val(this.username);
  				$(".txt_playersuper_name").val(this.name);
  				$(".txt_playersuper_place").val(this.city.toProperCase());
  				$(".txt_playersuper_age").val(this.age);
  				$(".txt_playersuper_about").val('<h3>To setninger om meg</h3>'+this.infotext3);
  				$(".txt_playersuper_about2").val('<h3>Hvor lenge har du spilt?</h3>'+this.infotext2);
  				$(".txt_infobox_title").val(this.build);
  				$(".txt_infobox_text").val(this.infotext1);
  				$(".txt_infobox_who").val(this.group_type.capitalize()+' fra '+this.city.toProperCase());
  			}
  		});
  	});

  	$("#playerBox").on('click', '.playerz .pl', function(e) {
  		userID = $(this).text();
  		$.each(minecraftData, function(i, e) {
  			if (this.username == userID) {
  				$(".txt_playersuper_username").val(this.username);
  				$(".txt_playersuper_name").val(this.name);
  				$(".txt_playersuper_place").val(this.city.toProperCase());
  				$(".txt_playersuper_age").val(this.age);
  				$(".txt_playersuper_about").val('<h3>To setninger om meg</h3>'+this.infotext3);
  				$(".txt_playersuper_about2").val('<h3>Hvor lenge har du spilt?</h3>'+this.infotext2);
  				$(".txt_infobox_title").val(this.build);
  				$(".txt_infobox_text").val(this.infotext1);
  				$(".txt_infobox_who").val(this.group_type.capitalize()+' fra '+this.city.toProperCase());  				
  			}
  		});
  	});

  	$("#playerBox").on('click', 'input.in_btn, input.out_btn', function(e) {
  		console.log(this);
  		if ($(this).hasClass('out_btn')) {
  			action = 'out';
  		} else {
  			action = 'in';
  		}
  		var container = $(this).parent().parent();
  		var data = {
  			id: $(container).find('input[type="hidden"]').val(),
  			name: $(container).find('.txt_playersuper_name').val(),
  			username: $(container).find('.txt_playersuper_username').val(),
  			city: $(container).find('.txt_playersuper_place').val(),
  			age: $(container).find('.txt_playersuper_age').val(),
  			infotext: [$(container).find('.txt_playersuper_about').val(), $(container).find('.txt_playersuper_about2').val(), $(container).find('.txt_playersuper_about3').val()],
  			action: action
  		};
  		socket.emit("playersuper", data);
  	});


  	$("#staticBox").on('click', 'input.staticchoice_select', function(e) {
  		console.log("HJe")
  		var fp = $(".staticchoice_data").val();
  		var title = fp.replaceAll('_', ' ');
  		title = title.split('.')[0];
  		$(".staticchoice_title").val(title);
  	});

  	$("#staticBox").on('click', 'input.staticsubmit', function(e) {
		if ($(this).hasClass('in_btn')) {
			action = 'in';
		} else {
			action = 'out';
		}
  		var container = $(this).parent();
  		var data = {
  			id: $(container).find('input[type="hidden"]').val(),
  			src: $(container).find('.staticchoice_data').val(),
  			title: $(container).find('.staticchoice_title').val(),
  			action: action
  		};
  		socket.emit('static_image', data);
  		console.log(data);
	});

  	$("#playerBox").on('click', 'input.infotxts', function(e) {
  		console.log("Clicked");
  		socket.emit("playersuper_info", parseInt($(this).val()));
  	});

  	$("#infoBox").on('click', 'input[type="submit"]', function(e) {
  		if ($(this).hasClass('infobox_inn')) {
  			action = 'in';
  		} else {
  			action = 'out';
  		}
  		var container = $(this).parent().parent();
  		var data = {
  			id: $(container).find('input[type="hidden"]').val(),
  			title: $(container).find('.txt_infobox_title').val(),
  			text: $(container).find('.txt_infobox_text').val(),
  			who: $(container).find('.txt_infobox_who').val(),
  			position: $(container).find('input[type="radio"]:checked').val(),
  			action: action
  		};
  		socket.emit('infobox', data);
  	});

  	$("#infoSuper").on('click', 'input[type="submit"]', function(e) {
  		if ($(this).hasClass('infosuper_inn')) {
  			action = 'in';
  		} else {
  			action = 'out';
  		}
  		var container = $(this).parent().parent();
  		var data = {
  			id: $(container).find('input[type="hidden"]').val(),
  			text: $(container).find('.txt_infosuper').val(),
  			position: $(container).find('input[type="radio"]:checked').val(),
  			action: action
  		};
  		socket.emit('infosuper', data);
  	});
  	$("#personSuper").on('click', '.personsuper_inn', function(e) {
  		var container = $(this).parent().parent();
  		var data = {
  			id: $(container).find('input[type="hidden"]').val(),
  			name: $(container).find('.txt_personsuper_name').val(),
  			title: $(container).find('.txt_personsuper_title').val(),
  			position: $(container).find('input[type="radio"]:checked').val(),
  		};
  		socket.emit('personsuper', data);
  	});

  	$("#personSuper").on('click', '.personsuper_csv_label input[type="submit"]', function(e) {
  		var choice = $(this).parent().find('select').val();
  		choice = config.personsuper[choice];
  		$(this).parent().parent().parent().find('.txt_personsuper_name').val(choice.name);
  		$(this).parent().parent().parent().find('.txt_personsuper_title').val(choice.title);
	});

  	$("#superBox").on('click', 'input.instagram_start', function(e) {
  		socket.emit('instagram', 1);
  	});
  	$("#superBox").on('click', 'input.instagram_out', function(e) {
  		socket.emit('instagram_out', 1);
  	});

  	$("#superBox").on('click', 'input.instagram_refresh', function(e) {
  		url = 'https://sombi.nrk.no/api/1.3/document?county='+$(".instagram_refresh_county").val()+'&moderation=1&projectId=5760092bfd3cf1f96d07c306';
  		socket.emit('instagram_refresh', url);
  	});

  	$("#superBox").on('change', 'input#activate_digas', function(e) {
  		console.log(this.checked);
  		socket.emit('activate_digas', this.checked);
  	});

  	$("#superBox").on('click', 'input.update_personsuper', function(e) {
  		socket.emit('get_personsuper', config.personsuper_csv);
  	});

  	$("#someBox").on('click', 'input.somebox_inn, input.somebox_out', function(e) {
  		if ($(this).hasClass('somebox_inn')) {
  			action = 'in';
  		} else {
  			action = 'out';
  		}
  		var container = $(this).parent().parent();
  		var data = {
  			id: $(container).find('input[type="hidden"]').val(),
  			title: $(container).find('.txt_somebox_title').val(),
  			username: $(container).find('.txt_somebox_username').val(),
  			text: $(container).find('.txt_somebox_text').val(),
  			position: $(container).find('input[type="radio"]:checked').val(),
  			source: $(container).find('input.some-source:checked').val(),
  			action: action
  		};
  		socket.emit('somesuper', data);
  	});


  	$("#locationSuper").on('click', 'input.smallmap_out, input.smallmap_inn', function(e) {
  		console.log(this);
  		if ($(this).hasClass("smallmap_inn")) {
  			socket.emit('smallmap', {action: 'in'});
  		} else {
  			socket.emit('smallmap', {action: 'out'});
  		}
  	});
  	$("#locationSuper").on('click', 'input.largemap_out, input.largemap_inn', function(e) {
  		console.log(this);
  		if ($(this).hasClass("largemap_inn")) {
  			socket.emit('largemap', {action: 'in', url: $(".bigmap_url").val()});
  		} else {
  			socket.emit('largemap', {action: 'out', url: $(".bigmap_url").val()});
  		}
  	});



  	$("#locationSuper").on('click', 'input.placesuper_out, input.placesuper_inn', function(e) {
  		console.log(this);
  		if ($(this).hasClass("placesuper_inn")) {
  			socket.emit('placesuper', {action: 'in'});
  		} else {
  			socket.emit('placesuper', {action: 'out'});
  		}
  	});

  	$(".restart_casparcg").click(function() {
  		socket.emit('restart_casparcg', 1);
  	});


  	$("#someBox").on('click', 'input.load_someurl', function(e) {
  		var container = $(this).parent().parent().parent();
  		socket.emit('get_some', {url: $(container).find(".txt_somebox_url").val(), id: $(container).find('input[type="hidden"]').val()});
  	});

  	socket.on('get_some', function(data) {
  		container = $('input[value="'+data.id+'"]').parent();
  		$(container).find('.some-source').prop('checked', false);
  		$(container).find(".txt_somebox_text").val(data.text);
  		$(container).find(".txt_somebox_title").val(data.title);
  		$(container).find(".txt_somebox_username").val(data.username);
  		$(container).find(".source-"+data.source).prop('checked', true);
  	});

  	socket.on('instagram_refresh', function(msg) {
  		console.log("Insta refresh", msg);
  	});

  	socket.on('get_personsuper', function(data) {
  		updatePersonsuper(data);
  	});


	socket.on('digas_super', function(cmd) {
		console.log(cmd);
		$("#digas").html(cmd.title);
	});

	socket.on('ws_msg', function(s) {
		s = JSON.parse(s);
		tmp = s;
		console.log(s);
		$(".playerz").html('');
		for (var obj in s.players) {
			var player = s.players[obj];
			$('<div class="pl">'+player.name+'</div>').appendTo(".playerz");
		}
	});


  });
</script>

</body>
</html>

