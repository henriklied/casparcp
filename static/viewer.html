<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>CasparCG Viewer</title>
	<script src="media/js/jquery.min.js"></script>
	<script src="media/js/sombiSlider.js"></script>
	<script src="media/js/typeit.min.js"></script>
	<script src="media/js/three.min.js"></script>
	<script src="media/js/2dskin.js"></script>
	<script src="media/js/smoothslide.min.js"></script>
	<link rel="stylesheet" type="text/css" href="media/css/common.css">
</head>
<body>

	<div id="container">
		<div class="county super"></div>
		<div class="reference_map super">
			<div class="dot"></div>
			<img src="media/gfx/minecraft/counties/referansekart_1.png" class="super countyImage">
		</div>
	</div>

</body>
<script src="/socket.io/socket.io.js"></script>
<script>
var config;
var socket = io();
var timers = [];
var infotexts = [];
function convertToRange(value, srcRange, dstRange){
  // value is outside source range return
  if (value < srcRange[0] || value > srcRange[1]){
    return NaN; 
  }

  var srcMax = srcRange[1] - srcRange[0],
      dstMax = dstRange[1] - dstRange[0],
      adjValue = value - srcRange[0];

  return (adjValue * dstMax / srcMax) + dstRange[0];

}

var county_graphics = {
	"Finnmark": "referansekart_1",
	"Troms": "referansekart_2",
	"Nord-Trøndelag": "referansekart_3",
	"Oppland": "referansekart_4",
	"Hedmark": "referansekart_5",
	"Oslo": "referansekart_6",
	"Akershus": "referansekart_7",
	"Østfold": "referansekart_8",
	"Vestfold": "referansekart_9",
	"Buskerud": "referansekart_10",
	"Telemark": "referansekart_11",
	"Aust-Agder": "referansekart_12",
	"Vest-Agder": "referansekart_13",
	"Rogaland": "referansekart_14",
	"Hordaland": "referansekart_15",
	"Sogn og Fjordane": "referansekart_16",
	"Møre og Romsdal": "referansekart_17",
	"Sør-Trøndelag": "referansekart_18",
	"Nordland": "referansekart_19",
	"Festival": "referansekart_senter"
};

var current_county;

$(document).ready(function() {

	$.get('config.json', function(data) {
		config = data;
		if (config.debug) {
			$("body").addClass("debug");
		}
		$('<link rel="stylesheet" type="text/css" href="media/css/'+config.layout+'.css">').appendTo("head");
		$.getScript('media/js/'+config.layout+'.js', function(data) {
		});
	});


	function clearSuper(s) {
		if (s.action == 'out') {
			$("#super_"+s.id).fadeOut('slow', function() {
					$("#super_"+s.id).remove();
			});
			return true;
		}
		if ($("#super_"+s.id).length) {
			$("#super_"+s.id).remove();
		}
		return false;
	}

	socket.on('all_out', function(e) {
		$(".super").fadeOut('slow', function() {			
			$(".super").remove();
		});
		for (var timer in timers) {
			clearTimeout(timers[timer]);
		}
		setTimeout(function() {
			timers = [];
		}, 800);
	});

  socket.on('personsuper', function(s) {
  	if (!clearSuper(s)) {
  		var html = '<div class="super personsuper '+s.position+'" id="super_'+s.id+'">\
  				<div class="name"><span class="ghost2">'+s.name+'</span></div>';
  		if (s.title != "") {
  			html += '<div class="title"><span class="ghost2">'+s.title+'</span></div>';
  		}
  		html += '</div>';
  		$(html).appendTo('#container');
  		$(document).trigger('personsuper', s);
  		$("#super_"+s.id).fadeIn(500, function() {
	  		$("#super_"+s.id).find('div.title').css('width', $("#super_"+s.id).find('div.title').width());
	  		$("#super_"+s.id).find('div.name').css('width', $("#super_"+s.id).find('div.name').width());
  		}).delay(6000).fadeOut('slow', function() {
				$(this).remove();
  		});
   		setTimeout(function() {
   			$("#super_"+s.id).find('span').removeClass("ghost2");
	  		$("#super_"+s.id).find('div.name span').typeIt({ speed: 30, breakLines: false, cursor: false });
	  		$("#super_"+s.id).find('div.title span').typeIt({ startDelay: 500, speed: 30, breakLines: false, cursor: false });
  		}, 550);

  	}
	});

socket.on('ws_msg', function(s) {
	s = JSON.parse(s);
	var from_top = s.camera.x;
	var from_left = s.camera.z;
	from_top = convertToRange(from_top, [-1350, 1350], [0, 242]);
	from_left = convertToRange(from_left, [-1350, 1350], [242, 0]);
	from_top_2 = convertToRange(from_top, [-1350, 1350], [0, 755]);
	from_left_2 = convertToRange(from_left, [-1350, 1350], [752, 0]);
	$(".reference_map .dot").animate({top: parseInt(from_top)+"px", left: parseInt(from_left)+"px"}, 1500);
});

socket.on('county', function(s) {
	if (s.county == current_county) {
		return true;
	}
	$("div.county span").remove();
	$("<span/>").appendTo('.county');
	$("div.county span").html(s.county);
	$("div.county span").typeIt({ speed: 30, breakLines: false, cursor: false });
	$("img.countyImage").attr('src', 'media/gfx/minecraft/counties/'+county_graphics[s.county]+'.png');
	current_county = s.county;
});

socket.on('largemap', function(s) {
	$('.largemap').fadeOut('slow', function() {
		$(".largemap").remove();
	});
	if (s.action == 'out') {
		return true;
	}
	$('<div class="largemap"><div class="dot"></div></div>').appendTo('#container');
	$('<iframe src="'+s.url+' border="0"/>').appendTo('.largemap');
	setTimeout(function() {
		$(".largemap").animate({opacity: 1}, 600);
	}, 1500);
});

// socket.emit('largemap', {url: 'http://139.162.190.146/mapcraft/latest/#world_topdown_day/0/2/187/-21/64'})

socket.on('playersuper', function(s){
	if (!clearSuper(s)) {
		var html = '<div class="super spillersuper" id="super_'+s.id+'">\
			<div class="username"><span class="ghost2">'+s.username+'</span></div>\
			<div class="real_name"><span class="ghost2">'+s.name+'</span></div>\
			<div class="avatar"><canvas id="canvas" width="64" height="64"></canvas><div id="model"></div></div>\
			<div class="metainfo"><span class="place ghost2">'+s.city+'</span> <span class="age ghost2">'+s.age+' år</span></div>\
			<div class="minecraft_info"><span class="ghost2"></span></div></div>';
		$(html).appendTo("#container");
		infotexts = s.infotext;
		loadMineCrafter(s.username);
		setTimeout(function() {
			$("#super_"+s.id).find('div.minecraft_info').css('height', 0);
		}, 600);
		$("#super_"+s.id).delay(500).fadeIn('slow', function() {
		});

		setTimeout(function() {
				$("#super_"+s.id).find('span').removeClass("ghost2");
	  		$("#super_"+s.id).find('div.username span').typeIt({ speed: 30, breakLines: true, cursor: false });
	  		$("#super_"+s.id).find('div.real_name span').typeIt({ startDelay: 1000, speed: 30, breakLines: true, cursor: false });
	  		$("#super_"+s.id).find('div.metainfo span').typeIt({ startDelay: 2000, speed: 30, breakLines: true, cursor: false });
	  		// $("#super_"+s.id).find('div.minecraft_info span').typeIt({ startDelay: 3000, speed: 30, breakLines: true, cursor: false });			
		}, 1500);

	};

});


	socket.on('playersuper_info', function(i) {
		var el = $('.spillersuper .minecraft_info');
		$(el).find('span').remove();
		$('<span/>').appendTo(el);
		$(el).find('span').addClass("ghost2").html(infotexts[i]);
		var curHeight = el.height(),
		autoHeight = el.css('height', 'auto').height();
		el.height(curHeight).animate({height: autoHeight}, 500);
		setTimeout(function() {
			$(el).find('span').removeClass("ghost2");
			$(el).find('span').typeIt({ speed: 30, breakLines: true, cursor: false });
		}, 1000);
	});

	socket.on('somesuper', function(s) {
		if (!clearSuper(s)) {
  		var html = '<div class="super somesuper '+s.position+' '+s.source+'" id="super_'+s.id+'"><div class="icon '+s.source+'"></div>';
			html += '<div class="title ghost">'+s.title+'</div>';
			html += '<div class="who"><span class="ghost2">@'+s.username+'</span></div>';
  		html += '<div class="text"><span class="ghost2">'+s.text+'</span></div></div>';
  		$(html).appendTo('#container');
  		$(document).trigger('superbox', s);
  		$("#super_"+s.id).fadeIn('slow');
  		$("#super_"+s.id).css('height', $("#super_"+s.id).height());
  		$("#super_"+s.id).find('div.text').css('height', $("#super_"+s.id).find('div.text').height());
   		setTimeout(function() {
  			$("#super_"+s.id).find('div.title').removeClass('ghost');
  			$("#super_"+s.id).find('div.text span').removeClass('ghost2');
  			$("#super_"+s.id).find('div.who span').removeClass('ghost2');
	  		$("#super_"+s.id).find('div.title').typeIt({ speed: 30, breakLines: true, cursor: false });
	  		$("#super_"+s.id).find('div.who').typeIt({ startDelay: 1000, speed: 30, breakLines: true, cursor: false });
	  		$("#super_"+s.id).find('div.text').typeIt({ startDelay: 2000, speed: 30, breakLines: true, cursor: false });
  		}, 1000);
 	}
	});

  socket.on('infosuper', function(s) {
  	if (!clearSuper(s)) {
  		var html = '<div class="super infosuper '+s.position+'" id="super_'+s.id+'">\
  				<div class="text ghost2">'+s.text+'</div></div>';
  		$(html).appendTo('#container');
  		$(document).trigger('infosuper', s);
  		$("#super_"+s.id).fadeIn('slow', function() {
	  		$("#super_"+s.id).css('height', $("#super_"+s.id).height());
	  		$("#super_"+s.id).css('width', $("#super_"+s.id).width());  			
  		});
   		setTimeout(function() {
				$("#super_"+s.id).find('div.text').removeClass('ghost2');
  			$("#super_"+s.id).find('div.text').typeIt({ speed: 30, breakLines: true, cursor: false });
			}, 1000);
  	}
	});

	socket.on('digassuper', function(s) {
		var html = '<div class="super digassuper bottomleft">\
		<div class="digas_title"><span class="ghost2">'+s.title+'</span></div>\
		<div class="digas_performer"><span class="ghost2">'+s.performer+'</span></div>\
		<div class="digas_extra"><span class="ghost2">'+s.recordcc+'  ℗ '+s.release_year+'</span></div></div>';
		$(html).appendTo('#container');
		$(document).trigger('digassuper', s);
		$('.digassuper').fadeIn('slow', function() {
			$('.digassuper').css('width', $(".digassuper").width());
		}).delay(10000).fadeOut('slow', function() {
			$(this).remove();
		});
		setTimeout(function() {
  			$(".digassuper").find('span').removeClass('ghost2');
	  		$(".digassuper").find('.digas_title').typeIt({ speed: 50, breakLines: true, cursor: false });
	  		$(".digassuper").find('.digas_performer').typeIt({ startDelay: 700, speed: 50, breakLines: true, cursor: false });
	  		$(".digassuper").find('.digas_extra').typeIt({ startDelay: 1400, speed: 50, breakLines: true, cursor: false });
		}, 1000);
	});

	socket.on('placesuper', function(s) {
		console.log(s.action);
		if (s.action == 'in') {
			$(".county").fadeIn();
		} else {
			console.log("Fading out");
			$(".county").fadeOut();			
		}
	});
	socket.on('smallmap', function(s) {
		if (s.action == 'in') {
			$(".reference_map").fadeIn();
		} else {
			$(".reference_map").fadeOut();			
		}
	});

  socket.on('infobox', function(s) {
  	if (!clearSuper(s)) {
  		var html = '<div class="super infobox '+s.position+'" id="super_'+s.id+'">';
			html += '<div class="title ghost">'+s.title+'</div>';
			html += '<div class="who"><span class="ghost2">'+s.who+'</span></div>';
  		html += '<div class="text ghost3">'+s.text+'</div></div>';
  		$(html).appendTo('#container');
  		$(document).trigger('infobox', s);
  		$("#super_"+s.id).fadeIn('slow', function() {
		  		$("#super_"+s.id).css('height', $("#super_"+s.id).height());
		  		$("#super_"+s.id).find('div.title').css('height', $("#super_"+s.id).find('div.title').height());
		  		$("#super_"+s.id).find('div.text').css('height', $("#super_"+s.id).find('div.text').height());
  		});

  		setTimeout(function() {
  			$("#super_"+s.id).find('div.title').removeClass('ghost');
  			$("#super_"+s.id).find('div.who span').removeClass('ghost2');
  			$("#super_"+s.id).find('div.text').removeClass('ghost3');
	  		$("#super_"+s.id).find('div.title').typeIt({ speed: 30, breakLines: true, cursor: false });
	  		$("#super_"+s.id).find('div.who span').typeIt({ startDelay: 1000, speed: 30, breakLines: true, cursor: false });
	  		$("#super_"+s.id).find('div.text').typeIt({ startDelay: 2000, speed: 30, breakLines: true, cursor: false });
  		}, 1000);
  	}
	});

	socket.on('static_image', function(s) {
		if (!clearSuper(s)) {
			var html = '<div class="staticimg super" id="super_'+s.id+'"></div>';
			$(html).appendTo('#container');
			$('<div class="title"><h2>'+s.title+'</h2></div>').appendTo('.staticimg');
			$('<div class="shower"></div>').appendTo('.staticimg');
			$('<img src="shared/'+s.src+'">').appendTo('.staticimg .shower');
			$(".staticimg").fadeIn('slow');
		}
	});


	socket.on('instagram', function(s) {
		if (!clearSuper(s)) {
			unloadSlider();
			var html = '<div class="sombiSlider super" id="super_'+s.id+'"></div>';
			$(html).appendTo('#container');
			$('<div class="title"><h2></h2></div>').appendTo('.sombiSlider');
			$('<div class="hider"></div>').appendTo('.sombiSlider');
			$('<div class="shower"></div>').appendTo('.sombiSlider');
			$('<div class="desc"><p></p></div>').appendTo('.sombiSlider');
			$.each(s.images, function(k,v) {
				var title = this.title;
				if (title.length > 140) {
					title = title.substring(0, 140)+'…';
				}
				$('<img src="'+this.url+'" data-title="'+title+'" data-user="'+this.user.username+'">').appendTo('.sombiSlider');
			});
			$(".sombiSlider").fadeIn('slow');
			loadSlider();
		}
	});

	socket.on('instagram_out', function(s) {
		$(".sombiSlider").fadeOut("slow", function() {
			$(this).remove();
		});		
	})

});
</script>
</html>